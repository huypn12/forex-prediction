%% Load data
eurusdCsvPath = 'EURUSD_15m_BID_sample.csv';
eurusd = readtable(eurusdCsvPath, 'Format', '%s%f%f%f%f%f');
euOpen = eurusd.('Open');
euOpen = euOpen(:);
euClose = eurusd.('Close');
euClose = euClose(:);
euHigh = eurusd.('High');
euHigh = euHigh(:);
euLow = eurusd.('Low');
euLow = euLow(:);

dataset = [euOpen euClose euHigh euLow];
dataset = dataset.';
xTrain = dataset(:, 1:end-1);
yTrain = dataset(:, 2:end);

%% Build lstm model
numFeatures = 4;
numHiddenUnits = 50;
numResponses = 4;
lstmNet = [ ...
    sequenceInputLayer(numFeatures),...
    lstmLayer(numHiddenUnits, 'OutputMode', 'sequence'),...
    lstmLayer(numHiddenUnits, 'OutputMode', 'sequence'),...
    fullyConnectedLayer(50),...
    dropoutLayer(0.5),...   
    fullyConnectedLayer(numResponses),...
    regressionLayer
    ];

%% Train the model
options = trainingOptions(...
    'adam', ...
    'MaxEpochs', 20, ...
    'GradientThreshold',1, ...
    'InitialLearnRate',0.005, ...
    'LearnRateSchedule','piecewise', ...
    'LearnRateDropPeriod',125, ...
    'LearnRateDropFactor',0.2, ...
    'Verbose',0, ...
    'Plots','training-progress', ...
    'ExecutionEnvironment','cpu'...
    );

lstmNet = trainNetwork(xTrain, yTrain, lstmNet, options);
